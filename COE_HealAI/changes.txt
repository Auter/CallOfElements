================================================================================
CALL OF ELEMENTS - HEALAI FORK - CHANGELOG
================================================================================

v3.12.5 - Macro Entry Point
---------------------------------------------------------------------------
NEW FEATURE:
- Added global function Coa_HealAI() for macro usage
  
  Usage:
      /run Coa_HealAI()
  
  This triggers the same smart healing behavior as the HealAI keybind.
  Safe to call anytime - silently does nothing if addon is not ready
  or HealAI is disabled.

v3.12.4 - Shield Reminder Display Improvements
---------------------------------------------------------------------------
CHANGES:
- Removed "Shield –" prefix from indicator text
  * Now shows: "Water Shield (7)" instead of "Shield – Active Water Shield (7)"
  * Missing state shows just: "MISSING"
  
- Combat-based visual styling:
  * In combat: Full opacity (100%), colored text (green/yellow/red)
  * Out of combat: 30% frame opacity, grey text
  
- Reduced minimum frame width from 120px to 80px (cleaner look)

v3.12.3 - Shield Reminder Critical Fix
---------------------------------------------------------------------------
CRITICAL FIX:
- Fixed "attempt to compare nil with number" error on line 541
  ROOT CAUSE: SHIELD_UPDATE_INTERVAL was defined AFTER the OnUpdate function
  that used it, so Lua saw it as nil during execution.
  FIX: Moved all shield constants (SHIELD_UPDATE_INTERVAL, SHIELD_NAMES,
  COE_QoL.lastShieldUpdate) to the TOP of COE_SuperWoW_QoL.lua with the
  other constants, ensuring they exist before OnUpdate runs.

UI FIX:
- Tightened checkbox spacing in Core tab to prevent "Enable Shield Reminder"
  from overlapping the Close button. Reduced vertical gaps from -8/-18 to -2/-12.

v3.12.2 - Shield Reminder Refinements
---------------------------------------------------------------------------
FIXES:
1. Shield name now shows clean pattern ("Water Shield") instead of tooltip text
   - Prevents any rank/number suffixes from appearing in the display
2. Added additional nil guards throughout shield detection
3. Auto-sizing frame: minimum 120px, maximum 300px width
4. Debug output shows actual stack count when /coe debug is enabled

NOTE: If you still see "attempt to compare nil with number" errors, please
      delete your WTF folder cache and reload the addon. The fix is in place
      but WoW may be running cached Lua from the old version.

v3.12.1 - Shield Reminder Bug Fixes
---------------------------------------------------------------------------
BUG FIXES:

1. Fixed "attempt to compare nil with number" error (line 541)
   - ROOT CAUSE: UnitBuff() returns nil for stack count on some shields,
     and the code compared this nil value directly
   - FIX: Created robust COE_HealAI_GetShieldState() function that:
     * Always returns stacks as integer (defaults to 0 if nil)
     * Returns state as "MISSING", "LOW", or "OK" string
     * Never performs nil comparisons

2. Fixed Shield Reminder checkbox appearing off-screen
   - ROOT CAUSE: Checkbox was anchored to a header that had negative offsets
   - FIX: Removed unnecessary "Shaman Buffs:" header, anchored checkbox
     directly under "Ignore pets and guardians" checkbox

3. Improved reminder text format
   - Now shows: "Shield – Active Water Shield(5)" or "Shield – Low Lightning Shield(2)"
   - Single line display instead of two separate lines
   - Wider frame (140px) to accommodate longer text

TECHNICAL CHANGES:
- New global function: COE_HealAI_GetShieldState(unit)
  Returns: state ("MISSING"/"LOW"/"OK"), shieldName (string or nil), stacks (integer)
- New global function: COE_HealAI_UpdateShieldReminder()
  Updates display using the robust state detection
- Added nil-safe checks in OnUpdate handler for all throttle timestamps

v3.12.0 - Shaman Shield Reminder
---------------------------------------------------------------------------
NEW FEATURE: Shield Reminder Frame

A simple, informational indicator showing the status of your Water, Lightning,
or Earth Shield buff. Helps you maintain shield uptime without staring at
your buff bar.

Visual states:
- "Shield – Active" (green): Shield is up with 4+ stacks
- "Shield – Low" (yellow): Shield is up but only 1-3 stacks remaining
- "Shield – Missing" (red in combat, grey out of combat): No shield buff

Features:
- Tracks Lightning Shield, Water Shield, and Earth Shield (including Turtle WoW)
- Shows the shield type abbreviation and stack count (e.g., "LS (7)", "WS (5)")
- Small movable frame - drag to reposition, position saved between sessions
- Red "Missing" warning only appears while in combat (not in town/resting)
- No automation: purely visual, no casting, no keybind interference

UI Location:
- Enable in HealAI config → Core tab → "Shaman Buffs" section
- Checkbox: "Enable Shield Reminder"

Does NOT require SuperWoW - uses standard UnitBuff API.

v3.11.1 - Dispel Fix & Pet Healing Fix
---------------------------------------------------------------------------
BUG FIXES:

1. Dispel "Nothing to dispel" Error Fix
   - ROOT CAUSE: Dispel code used CastSpell() + SpellTargetUnit() pattern,
     which doesn't work for helpful spells in Vanilla 1.12
   - FIX: Changed to TargetUnit() before CastSpell() (same as healing)
   - Dispels now correctly target the unit with the debuff
   - Added comprehensive debug output for dispel scanning:
     * Shows each debuff scanned with type and texture
     * Shows which unit/debuff was selected for dispel
     * Shows the exact spell and unit ID used for casting

2. Pet Healing Not Working Fix
   - ROOT CAUSE: When HB_IgnorePets was 0 (OFF), the code evaluated
     (HB_IgnorePets == 1) as false, but ignorePets defaulted to true,
     so it remained true instead of becoming false
   - FIX: Added explicit nil check and proper assignment:
     * If HB_IgnorePets is nil (never set), defaults to true (ignore)
     * If HB_IgnorePets is 1, ignorePets = true (ignore)
     * If HB_IgnorePets is 0, ignorePets = false (include pets)
   - Warlock/Hunter pets now properly included as heal candidates when
     "Ignore pets" checkbox is unchecked
   - Added debug output for pet candidate handling:
     * Shows ignorePets setting value
     * Shows each pet being checked or skipped
     * Shows when pets are added as candidates

TECHNICAL NOTES:
- Spam mode still always ignores pets (by design)
- No UI changes - existing checkbox behavior now works correctly
- Debug output via /coe debug shows full dispel and pet handling trace

v3.11.0 - QuickHeal-Inspired Heal Prediction
---------------------------------------------------------------------------
Major improvement to rank selection logic, inspired by the QuickHeal addon.
HealAI now makes smarter decisions about which spell rank to use based on
accurate heal predictions rather than simple base values.

NEW FEATURES:

1. Smarter Rank Selection
   - Healing Wave, Lesser Healing Wave, and Chain Heal now use predicted
     heal amounts instead of base tooltip values
   - Accounts for +healing gear bonus with proper spell coefficients:
     * Lesser Healing Wave: 42.86% of +healing (1.5s cast)
     * Healing Wave: 85.71% of +healing (3.0s cast)
     * Chain Heal: 61.42% of +healing (Turtle WoW coefficient)
   - Sub-level-20 penalty factors for downranked Healing Wave (ranks 1-4)

2. Healing Debuff Compensation
   - Detects healing reduction debuffs on targets (Mortal Strike, Veil of
     Shadow, Necrotic Poison, etc.)
   - Automatically inflates heal need to compensate for reduced healing
   - Example: 800 HP missing + Mortal Strike (50%) = selects rank for 1600 HP

3. Combat Damage Padding
   - When in combat, accounts for damage taken during spell cast time
   - Fast spells (LHW): aims for 90% of deficit
   - Slow spells (HW): aims for 80% of deficit
   - Results in slightly larger heals during active combat

4. Mana-Aware Rank Selection
   - Integrates Tidal Focus talent for accurate mana cost calculations
   - Won't select spell ranks the player cannot afford
   - 5/5 Tidal Focus = 5% mana discount applied to all checks

5. Healing Way Stack Detection
   - Detects Healing Way buff stacks on heal target
   - Applies 6% bonus per stack (up to 18% at 3 stacks) to HW predictions
   - Enables more accurate downranking when Healing Way is active

6. Nature's Swiftness Intelligence
   - Detects when Nature's Swiftness buff is active
   - Emergency heals prefer Healing Wave over LHW when NS is up
   - Maximizes the value of instant-cast heal window

TECHNICAL NOTES:
- Optional ItemBonusLib integration for +healing detection (graceful fallback)
- All adjustments stack: debuffs, combat padding, and Healing Way combine
- Existing HealComm integration unchanged (adjustments apply after HealComm)
- No new UI options required - behavior is automatic based on game state
- Comprehensive debug output with /coe debug shows all prediction math

v3.10.0 - SuperWoW QoL Features: Totem Range Overview & Tank Distance Hint
---------------------------------------------------------------------------
NEW: Two informational SuperWoW-powered features (require UnitPosition API):

1. Totem Range Overview Panel (Raid tab checkbox)
   - Shows how many group members are within 20y of your active totems
   - Per-element display: Earth: 3/5, Fire: 4/5, etc.
   - Color-coded: green (all in range), yellow (some), red (few)
   - Movable panel, position saved in SavedVariables
   - Checkbox: "Show totem range overview" in Raid tab

2. Tank Distance Hint (Core tab checkbox)
   - Shows distance to configured tank/off-tank
   - Color-coded: green (<=30y), yellow (30-38y), red (>38y)
   - Movable frame, position saved in SavedVariables
   - Checkbox: "Show tank distance hint" in Core tab

Both features:
- Are purely informational (no automation, no behavior changes)
- Degrade gracefully if SuperWoW/UnitPosition unavailable
- Have small grey "Requires SuperWoW (UnitPosition)" notes in UI
- Do NOT interfere with existing HealAI logic or totem behavior

v3.9.1 - Chain Heal Anchor Selection: Lowest HP Priority
------------------------------------------------------------------------
- BREAKING: Chain Heal auto-selection now requires SuperWoW's UnitPosition API
- Without UnitPosition, HealAI will NOT auto-cast Chain Heal (falls back to
  single-target heals). You can still cast Chain Heal manually.
- Replaced all UnitXYZ-based distance code with UnitPosition (2D coordinates)
- Clustering logic now correctly measures distance from the PRIMARY TARGET,
  not from the player position. This matches how Chain Heal actually bounces.
- Added /coe superwow command to test detection and show available APIs
- UI shows clear status: "SuperWoW position API detected" or warning note
- Comprehensive debug output with /coe debug shows exact distances and decisions
- Fixed threshold comparison: units at exactly the threshold % now count as injured

v3.6.0 - HealAI Rename & Documentation
----------------------------------------
- Renamed healing module from "HealBrain" to "HealAI" throughout
- Updated all user-facing UI labels, keybind names, and documentation
- Internal SavedVariable keys (HB_*) retained for backwards compatibility
- Comprehensive readme rewrite with accurate feature documentation
- Cleaned up changelog, removed outdated WIP references

v3.5.2 - Anti-Spam Bypass for Spam Mode
----------------------------------------
- Anti-spam penalty now correctly bypassed in spam/maintenance mode
- Added isSpamMode parameter to DetermineHealTarget()
- Spam mode allows repeated heals on same target without hesitation
- Unreachable unit penalty remains active in all modes

v3.5.1 - Out-of-Range Fallback Fix
----------------------------------------
- Fixed critical bug where one out-of-range target could brick all healing
- DetermineHealTarget() now returns sorted list of ALL candidates
- Heal functions iterate through candidates until one passes range check
- Added unreachable unit tracking with 3-second penalty window
- Units that fail CanReachForCast() are deprioritized on subsequent presses

v3.5.0 - Tank Priority & Anti-Spam Improvements
----------------------------------------
- Tank priority is now a bias, not absolute lock
- Non-tanks with significantly lower HP (20%+ difference) override tank priority
- Non-tanks below emergency threshold always override tank priority
- Chain Heal skipped when Tank Emergency Override is triggered
- Dead/ghost/offline units properly skipped in all heal modes
- Anti-spam logic prevents double-healing same target when spamming
- Improved pet detection for "Ignore pets" setting

v3.4.1 - Final Range Check Fix
----------------------------------------
- Added CanReachForCast() as authoritative Blizzard API range check
- Final range check uses CheckInteractDistance() before any cast
- Self-casts no longer happen when intended target is out of range
- Range check added to BestHeal, DoSpamHeal, Dispel, and CastChainHeal

v3.4.0 - SuperWoW Range/LoS Bug Fix + Tank Emergency Override
----------------------------------------
- Fixed SuperWoW returning garbage distance data (45000+ yards)
- Added 200-yard sanity clamp for range checks
- Three-state reachability: true (reachable), false (unreachable), nil (unknown)
- Removed unreachable fallback table - unreachable units are skipped entirely
- Added Tank Emergency Override feature with configurable threshold
- Tank emergency can optionally bypass HealComm incoming heal checks

v3.3.0 - Casting Fix & Keybind Cleanup
----------------------------------------
- Fixed Vanilla 1.12 spell targeting bug (heals landing on self)
- Uses TargetUnit() before CastSpell() for correct target
- Cleaned up keybind system in Bindings.xml
- Added UI tooltips for all settings

v3.2.0 - SuperWoW Integration & Dispel Throttle
----------------------------------------
- SuperWoW range and LoS checking with safe fallback
- Dispel throttle system to prevent dispel spam
- Conservative HealComm overheal cancellation
- Fixed COETooltip error

v3.1.0 - HealComm Integration & Chain Heal
----------------------------------------
- HealComm-1.0 integration for incoming heal awareness
- Group-based Chain Heal logic (bounces within same party only)
- Configurable minimum targets for Chain Heal

v3.0.0 - HealAI Core Implementation
----------------------------------------
- Complete smart healing decision engine
- Tank priority with main tank and off-tank support
- Target-of-Target fallback when no tank names configured
- Emergency threshold for fast heal switching
- Top-up threshold to avoid overhealing
- Spam mode for maintenance healing
- Dispel integration with HP gate

================================================================================
ORIGINAL CALL OF ELEMENTS CHANGELOG (Pre-fork)
================================================================================

v2.8
- Various fixes

v2.7
- Save positions
- ruRU localization

v2.6
- Korean localization
- Performance upgrades (memory leak fixes)
- Fixed disappearing element frames

v2.5
- Chinese (simplified) localization
- Totem sets for named targets
- Tremor totem advisor additions
- CTRL-click to change anchor totem

v2.4
- Enamored Water Spirit trinket support
- French localization
- Lag-dependent timer activation
- Various fixes

v2.3
- /coe priorset command
- Option for timer frame only display
- PVP auto-switch improvements

v2.2
- Basic healing module added
- Totem advisor improvements

v2.1
- Flex/Closed mode improvements
- Separate timer frame option
- Scaling option

v1.8
- Cooldown display in red digits
- Set restart functionality
- Removed totem bar backdrop

v1.7
- Bar position locking
- Customizable totem ordering
- Shell command list

v1.6
- Tremor totem advisor additions
- Tooltip disable option

v1.5
- Customize mode with bar configuration
- Button alignment options

v1.4
- Seventh air totem button added
